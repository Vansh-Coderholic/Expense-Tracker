{% extends "base.html" %}

{% block content %}

<div class="row">
    <!-- Filters -->
    <div class="col-md-7">
        <div class="card p-4 mb-4">
            <h5>Filters</h5>

            <form method="GET" action="/">
                <div class="row">
                    <div class="col-md-4">
                        <label>Start</label>
                        <input type="date" class="form-control" name="start">
                    </div>

                    <div class="col-md-4">
                        <label>End</label>
                        <input type="date" class="form-control" name="end">
                    </div>

                    <div class="col-md-4">
                        <label>Category</label>
                        <select class="form-select" name="category">
                            <option>All</option>
                            <option>Food</option>
                            <option>Transport</option>
                            <option>Shopping</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-primary btn-custom">Apply</button>
                    <a href="/" class="btn btn-secondary">Reset</a>
                </div>

                <div class="mt-3">
                    <strong class="total-label">Total:</strong>
                    <span class="badge bg-secondary">₹{{ "%.2f"|format(total_expenses) }}</span>
                </div>

                <a href="{{url_for('export_csv', start=start_str, end=end_str,category = category)}}"
                    class = "small mt-2 d-block">
                Export CSV(current filter)
            </a>
            </form>
        </div>
    </div>

    <!-- Add Expense -->
    <div class="col-md-5">
        <div class="card p-4 mb-4">
            <h5>Add Expense</h5>

            <form method="POST" action="{{ url_for('add') }}">
                <label>Description</label>
                <input type="text" class="form-control mb-2" name="description" placeholder="e.g. Groceries">

                <div class="row">
                    <div class="col">
                        <label>Amount</label>
                        <input type="number" step="0.01" class="form-control" name="amount" value="25.00">
                    </div>
                    <div class="col">
                        <label>Date</label>
                        <input type="date" class="form-control" name="date">
                    </div>
                </div>

                <label class="mt-2">Category</label>
                <select class="form-select mb-3" name="category">
                    <option>Food</option>
                    <option>Transport</option>
                    <option>Shopping</option>
                    <option>Other</option>
                </select>

                <button class="btn btn-primary w-100 btn-custom">Add Expense</button>
            </form>
        </div>
    </div>
</div>

<!-- Expense Table -->
<div class="card p-3 mt-3">
    <h5>Expenses</h5>

    <table class="table table-dark table-striped table-expenses mt-3">
        <thead>
            <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Category</th>
                <th>Amount</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            {% for item in expenses %}
            <tr>
                <td>{{ item.date }}</td>
                <td>{{ item.description }}</td>
                <td>{{ item.category }}</td>
                <td>₹{{ "%.2f"|format(item.amount) }}</td>
                <td>

                    <a href ="{{url_for('edit', expense_id = item.id)}}"
                    class ="btnn btn-sm btn-secondary me-1">
                    Edit
                </a>

                    <form method="POST" action="{{url_for('delete',expense_id=item.id)}}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger" 
                        onclick="return confirm('Delete this expense?');">
                        Delete
                    </button>
                    </form>
                </td>
            </tr>
            {% else %}
                <tr><td colspan="5" class="text-center">No expenses yet — add your first one above.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card p-4 h-100">
                <h5>Category Breakdown</h5>
                <canvas id="catChart" height="200"></canvas>
            </div>
        </div>
        <div class="col-md-6">
        <div class="card p-4 h-100">
            <h5>Daily Spending Trend</h5>
            <canvas id="dayChart" height="200"></canvas>
    </div>

    
        </div>
    </div>

    <script>
        
        const catLabels = {{ (cat_labels or []) | tojson }};
        const catValues = {{ (cat_values or []) | tojson }};
        const chartCanvas = document.getElementById('catChart');


        if(chartCanvas && catLabels.length > 0 && catValues.length > 0){
            const catCtx = document.getElementById('catChart').getContext('2d');

            new Chart(catCtx, {
                type: 'pie',
                data: {
                    labels: catLabels,
                    datasets: [{
                        data: catValues,
                        backgroundColor: [
                            '#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff'
                        ],
                        borderColor: '#222',
                        borderWidth: 1
                    }]
                },
                options:{
                    plugins:{
                        legend:{
                            labels:{
                                color:'#cbd5e1'
                            }
                        }
                    }
                }
            });
        }

        const dayLabels = {{ (day_labels or []) | tojson }};
        const dayValues = {{ (day_values or []) | tojson }};
        const dayCanvas = document.getElementById('dayChart');

        if(dayCanvas && dayLabels.length > 0 && dayValues.length > 0) {
            const dayCtx = dayCanvas.getContext('2d');

            new Chart(dayCtx, {
                type: 'line',
                data: {
                    labels: dayLabels,
                    datasets:[{
                        label: 'Daily Spending(₹)',
                        data: dayValues,
                        tension: 0.3,
                        borderWidth: 2,
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        x: {ticks: { color: '#cbd5e1'}},
                        y: {ticks: { color: '#cbd5e1'}}
                    },
                    plugins:{
                        legend:{
                            labels:{color:'#cbd5e1'}
                        }
                    }
                }
            });
        }
    </script>

{% endblock %}
